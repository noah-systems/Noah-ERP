services:
  db:
    build:
      context: ..
      dockerfile: docker/apps/db/Dockerfile
    environment:
      POSTGRES_DB: noah
      POSTGRES_USER: noah
      POSTGRES_PASSWORD: q@9dlyU0AAJ9
    volumes: ["db_data:/var/lib/postgresql/data"]
    networks: [noah]

  redis:
    image: redis:7-alpine
    networks: [noah]

  api:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
      args:
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
        NPM_CONFIG_REGISTRY: ${NPM_CONFIG_REGISTRY:-https://registry.npmjs.org/}
    working_dir: /app/apps/api
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      PRISMA_MIGRATE_ON_START: 1
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_NAME: ${ADMIN_NAME}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      CORS_ORIGINS: ${CORS_ORIGINS}
    depends_on: [db, redis]
    networks: [noah]

  web:
    build:
      context: ..
      dockerfile: Dockerfile.web
      args:
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
        NPM_CONFIG_REGISTRY: ${NPM_CONFIG_REGISTRY:-https://registry.npmjs.org/}
    depends_on: [api]
    networks: [noah]

  proxy:
    image: nginx:alpine
    depends_on: [web, api]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - letsencrypt:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro
    networks: [noah]

  certbot:
    image: certbot/certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: /bin/sh
    command: -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot && echo 'certs renewed'; sleep 12h; done"

volumes:
  db_data: {}
  letsencrypt: {}
  certbot-www: {}

networks: { noah: {} }
