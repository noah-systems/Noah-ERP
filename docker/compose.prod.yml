services:
  db:
    build:
      context: ..
      dockerfile: docker/apps/db/Dockerfile
    environment:
      POSTGRES_DB: noah
      POSTGRES_USER: noah
      POSTGRES_PASSWORD: noah
    volumes: ["db_data:/var/lib/postgresql/data"]
    networks: [noah]

  redis:
    image: redis:7-alpine
    networks: [noah]

  api:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
    working_dir: /app/apps/api
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://noah:noah@db:5432/noah
      PRISMA_MIGRATE_ON_START: 0
      JWT_SECRET: supersecret-change-me
      REDIS_URL: redis://redis:6379
    depends_on: [db, redis]
    networks: [noah]

  web:
    build:
      context: ..
      dockerfile: Dockerfile.web
    depends_on: [api]
    networks: [noah]

  proxy:
    image: nginx:alpine
    depends_on: [web, api]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    networks: [noah]

  certbot:
    image: certbot/certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: /bin/sh
    command: -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot && echo 'certs renewed'; sleep 12h; done"

volumes:
  db_data: {}
  letsencrypt: {}
  certbot-www: {}

networks: { noah: {} }
