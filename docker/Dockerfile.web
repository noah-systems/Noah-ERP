# Build stage (Vite)
FROM node:20-alpine AS build
WORKDIR /work
COPY package.json package-lock.json* pnpm-lock.yaml* yarn.lock* ./
COPY apps/web/package.json ./apps/web/
RUN if [ -f package-lock.json ]; then npm ci --no-audit --no-fund; \
    else npm i --no-audit --no-fund; fi
COPY apps/web ./apps/web
WORKDIR /work/apps/web
RUN npm run build

# Runtime stage
FROM nginx:alpine
COPY --from=build /work/apps/web/dist /usr/share/nginx/html
# opcional: sendfile off para volume em alguns ambientes
RUN printf "server { \
  listen 80; \
  root /usr/share/nginx/html; \
  index index.html; \
  location / { try_files \$uri /index.html; } \
}\n" > /etc/nginx/conf.d/default.conf

EXPOSE 80
