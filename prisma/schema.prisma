datasource db { provider = "postgresql" url = env("DATABASE_URL") }
generator client { provider = "prisma-client-js" }

enum Role { ADMIN_NOAH SUPPORT_NOAH FINANCE_NOAH SELLER PARTNER_MASTER PARTNER_FINANCE PARTNER_OPS }
enum LeadSource { GOOGLE META MANUAL }
enum ImplStatus { PENDING_SCHED SCHEDULED DONE NO_SHOW }
enum Channel { INTERNAL WHITE_LABEL }
enum ItemKind { PLAN ADDON MODULE }
enum PartnerAccountStatus { PENDING_CREATE ACTIVE PENDING_CHANGE CANCELED }

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(SELLER)
  partnerId    String?
  partner      Partner? @relation(fields: [partnerId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  leads         Lead[]        @relation("LeadOwner")
  opportunities Opportunity[] @relation("OppOwner")
  histories     OppHistory[]  @relation("UserActorHistory")
}

model LeadStatus {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String
  tmkReasonRequired Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leads     Lead[]
}

model Lead {
  id        String     @id @default(cuid())
  company   String
  segment   String
  headcount Int        @default(0)
  contact   String
  phone     String
  email     String
  notes     String?
  source    LeadSource @default(MANUAL)
  statusId  String
  status    LeadStatus @relation(fields: [statusId], references: [id])
  ownerId   String
  owner     User       @relation("LeadOwner", fields: [ownerId], references: [id])
  opportunities Opportunity[] @relation("LeadOpps")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OpportunityStage {
  id        String @id @default(cuid())
  name      String @unique
  order     Int    @default(0)
  lostReasonRequired Boolean @default(false)
  opportunities Opportunity[]
}

model HostingProvider {
  id   String @id @default(cuid())
  name String
  opportunities Opportunity[]
  accounts     PartnerAccount[]
}

model Opportunity {
  id         String   @id @default(cuid())
  ownerId    String
  owner      User     @relation("OppOwner", fields: [ownerId], references: [id])
  leadId     String?
  lead       Lead?    @relation("LeadOpps", fields: [leadId], references: [id])
  stageId    String
  stage      OpportunityStage @relation(fields: [stageId], references: [id])
  hostingId  String?
  hosting    HostingProvider? @relation(fields: [hostingId], references: [id])
  legalName  String?
  cnpj       String?
  address    String?
  subdomain  String?
  users      Int      @default(0)
  whatsapp   Int      @default(0)
  instagram  Int      @default(0)
  facebook   Int      @default(0)
  waba       Int      @default(0)
  serverIp   String?
  trialStart DateTime?
  activation DateTime?
  billingBaseDay Int?
  priceTotal   Decimal? @db.Decimal(10,2)
  priceMonthly Decimal? @db.Decimal(10,2)
  history   OppHistory[]
  implTasks ImplementationTask[]
  canceled  CanceledSale?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OppHistory {
  id      String   @id @default(cuid())
  oppId   String
  opp     Opportunity @relation(fields: [oppId], references: [id])
  actorId String
  actor   User      @relation("UserActorHistory", fields: [actorId], references: [id])
  note    String?
  createdAt DateTime @default(now())
}

model ImplementationTask {
  id       String   @id @default(cuid())
  oppId    String
  opp      Opportunity @relation(fields: [oppId], references: [id])
  status   ImplStatus  @default(PENDING_SCHED)
  schedule DateTime?
  note     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CanceledSale {
  id    String @id @default(cuid())
  oppId String @unique
  opp   Opportunity @relation(fields: [oppId], references: [id])
  reason  String?
  summary String?
  createdAt DateTime @default(now())
}

model Partner {
  id          String   @id @default(cuid())
  nickname    String
  legalName   String
  cnpj        String
  address     String?
  domain      String?
  contact     String?
  whatsapp    String?
  financeEmail String?
  priceTable  Json?
  accounts PartnerAccount[]
  users    User[]
}

model PartnerAccount {
  id            String @id @default(cuid())
  partnerId     String
  partner       Partner @relation(fields: [partnerId], references: [id])
  legalName     String
  cnpj          String
  email         String
  phone         String?
  subdomain     String?
  users         Int?
  hostingId     String?
  hosting       HostingProvider? @relation(fields: [hostingId], references: [id])
  serverIp      String?
  billingBaseDay Int?
  connections   Json?
  modules       Json?
  status        PartnerAccountStatus @default(PENDING_CREATE)
  note          String?
  activatedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PartnerChangeRequest {
  id        String   @id @default(cuid())
  accountId String
  account   PartnerAccount @relation(fields: [accountId], references: [id])
  type      String
  payload   Json?
  createdAt DateTime @default(now())
}

model PriceItem {
  id     String  @id @default(cuid())
  sku    String  @unique
  name   String
  price  Decimal @db.Decimal(10,2)
  channel Channel
  kind   ItemKind
  active Boolean @default(true)
}

model PriceTier {
  id           String  @id @default(cuid())
  channel      Channel
  minUsers     Int
  maxUsers     Int
  pricePerUser Decimal @db.Decimal(10,2)
}

model DiscountPolicy {
  id         String @id @default(cuid())
  role       Role
  maxPercent Decimal @db.Decimal(5,2)
}
