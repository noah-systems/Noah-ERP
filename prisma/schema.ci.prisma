datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

// NOTE: This CI schema mirrors the production datamodel but swaps PostgreSQL-only features
// (enums, JSON columns, and native Decimal types) for SQLite-compatible equivalents so that
// `prisma validate`/`prisma generate` can run in environments without Docker or Postgres. The
// application restores the richer typings through module augmentation in
// `apps/api/src/types/prisma.d.ts`.

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         String   @default("SELLER")
  partnerId    String?
  partner      Partner? @relation(fields: [partnerId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  leads         Lead[]        @relation("LeadOwner")
  opportunities Opportunity[] @relation("OppOwner")
  histories     OppHistory[]  @relation("UserActorHistory")
}

model LeadStatus {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String
  tmkReasonRequired Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leads     Lead[]
}

model Lead {
  id        String     @id @default(cuid())
  company   String
  name      String
  segment   String?
  headcount Int?       @default(0)
  contact   String?
  phone     String?
  email     String?
  notes     String?
  source    String @default("MANUAL")
  statusId  String
  status    LeadStatus @relation(fields: [statusId], references: [id])
  ownerId   String
  owner     User       @relation("LeadOwner", fields: [ownerId], references: [id])
  opportunities Opportunity[] @relation("LeadOpps")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OpportunityStage {
  id        String @id @default(cuid())
  name      String @unique
  order     Int    @default(0)
  lostReasonRequired Boolean @default(false)
  opportunities Opportunity[]
  historyFrom OppHistory[] @relation("OppHistoryFromStage")
  historyTo   OppHistory[] @relation("OppHistoryToStage")
}

model HostingProvider {
  id   String @id @default(cuid())
  name String
  opportunities Opportunity[]
  accounts     PartnerAccount[]
}

model Opportunity {
  id         String   @id @default(cuid())
  ownerId    String
  owner      User     @relation("OppOwner", fields: [ownerId], references: [id])
  leadId     String?
  lead       Lead?    @relation("LeadOpps", fields: [leadId], references: [id])
  stageId    String
  stage      OpportunityStage @relation(fields: [stageId], references: [id])
  hostingId  String?
  hosting    HostingProvider? @relation(fields: [hostingId], references: [id])
  legalName  String?
  cnpj       String?
  address    String?
  subdomain  String?
  users      Int      @default(0)
  whatsapp   Int      @default(0)
  instagram  Int      @default(0)
  facebook   Int      @default(0)
  waba       Int      @default(0)
  serverIp   String?
  trialStart DateTime?
  activation DateTime?
  billingBaseDay Int?
  priceTotal   Decimal?
  priceMonthly Decimal?
  history   OppHistory[]
  implTasks ImplementationTask[]
  canceled  CanceledSale?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OppHistory {
  id      String   @id @default(cuid())
  oppId   String
  opp     Opportunity @relation(fields: [oppId], references: [id])
  actorId String
  actor   User      @relation("UserActorHistory", fields: [actorId], references: [id])
  fromStageId String?
  fromStage   OpportunityStage? @relation("OppHistoryFromStage", fields: [fromStageId], references: [id])
  toStageId   String?
  toStage     OpportunityStage? @relation("OppHistoryToStage", fields: [toStageId], references: [id])
  note    String?
  createdAt DateTime @default(now())
}

model ImplementationTask {
  id       String   @id @default(cuid())
  oppId    String
  opp      Opportunity @relation(fields: [oppId], references: [id])
  status   String  @default("PENDING_SCHED")
  schedule DateTime?
  note     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CanceledSale {
  id    String @id @default(cuid())
  oppId String @unique
  opp   Opportunity @relation(fields: [oppId], references: [id])
  reason  String?
  summary String?
  createdAt DateTime @default(now())
}

model Partner {
  id          String   @id @default(cuid())
  nickname    String
  legalName   String
  cnpj        String
  address     String?
  domain      String?
  contact     String?
  whatsapp    String?
  financeEmail String?
  priceTable  String?
  accounts PartnerAccount[]
  users    User[]
}

model PartnerAccount {
  id            String @id @default(cuid())
  partnerId     String
  partner       Partner @relation(fields: [partnerId], references: [id])
  legalName     String
  cnpj          String
  email         String
  phone         String?
  subdomain     String?
  users         Int?
  hostingId     String?
  hosting       HostingProvider? @relation(fields: [hostingId], references: [id])
  serverIp      String?
  billingBaseDay Int?
  connections   String?
  modules       String?
  status        String @default("PENDING_CREATE")
  note          String?
  activatedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  changeRequests PartnerChangeRequest[]
}

model PartnerChangeRequest {
  id        String   @id @default(cuid())
  accountId String
  account   PartnerAccount @relation(fields: [accountId], references: [id])
  type      String
  payload   String?
  createdAt DateTime @default(now())
}

model PriceItem {
  id     String  @id @default(cuid())
  sku    String  @unique
  name   String
  price  Decimal
  channel String
  kind   String
  active Boolean @default(true)
}

model PriceTier {
  id           String  @id @default(cuid())
  channel      String
  minUsers     Int
  maxUsers     Int?
  pricePerUser Decimal

  @@unique([channel, minUsers])
}

model DiscountPolicy {
  id         String @id @default(cuid())
  role       String   @unique
  maxPercent Decimal
}
