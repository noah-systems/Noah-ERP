FROM node:20-bookworm-slim AS build
WORKDIR /work

COPY package.json package-lock.json* pnpm-lock.yaml* yarn.lock* .npmrc* ./
COPY vendor ./vendor

RUN set -eux; \
  npm config set fund false; \
  npm config set audit false; \
  npm config set fetch-retry-mintimeout 20000; \
  npm config set fetch-retry-maxtimeout 120000; \
  npm config set fetch-retry-factor 10; \
  npm config set registry https://registry.npmjs.org; \
  if [ -f package-lock.json ]; then \
    npm ci --no-audit --no-fund || npm install --no-audit --no-fund --legacy-peer-deps; \
  else \
    npm install --no-audit --no-fund --legacy-peer-deps; \
  fi

RUN npm rebuild rollup --force || true

COPY . .

RUN npm run build:web

FROM nginx:alpine
COPY --from=build /work/dist /usr/share/nginx/html
