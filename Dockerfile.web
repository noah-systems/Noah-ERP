FROM node:20-bookworm-slim AS build
WORKDIR /work

RUN npm config set fund false \
 && npm config set audit false \
 && npm config set fetch-retry-mintimeout 20000 \
 && npm config set fetch-retry-maxtimeout 120000 \
 && npm config set fetch-retry-factor 10 \
 && npm config set registry https://registry.npmmirror.com

COPY package*.json ./

ENV npm_config_optional=true

RUN npm ci --no-audit --no-fund --include=optional \
 || npm install --no-audit --no-fund --legacy-peer-deps --include=optional

RUN npm rebuild rollup --force || true

COPY . ./

RUN npm run build:web

FROM nginx:alpine
COPY --from=build /work/dist /usr/share/nginx/html
